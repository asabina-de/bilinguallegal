\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{longinvoice}[2018/06/08]

\RequirePackage{}

\DeclareOption{de_DE}{
  \input{lang/de_DE.def}
}
\DeclareOption{en_US}{
  \input{lang/en_US.def}
}

\ExecuteOptions{en_US}
\ProcessOptions\relax

%\input{agreement.def}

% Define counters for clauses and subclauses
\newcounter{clausecount}[section]
\newcounter{subclausecount}[clausecount]
\newcounter{subsubclausecount}[subclausecount]
\renewcommand{\theclausecount}{\thesection.\arabic{clausecount}}
\renewcommand{\thesubclausecount}{\theclausecount.\arabic{subclausecount}}
\renewcommand{\thesubsubclausecount}{\thesubclausecount.\arabic{subsubclausecount}}

% Section
\newcounter{seccoun} % Counter for sections
\setcounter{seccoun}{1}
\newcommand{\addsection}[2]{%
  \begin{sloppypar}  % To prevent overfull lines
    \begin{paracol}{2} % specify two columns...
      \begin{leftcolumn*}
        \toftagthis{d}
        \section{\texorpdfstring{#1}{#1 --- #2}}
      \end{leftcolumn*}
      \begin{rightcolumn}
        \toftagthis{e}
        \hypersetup{bookmarksdepth=-2}
        \section{#2}
        \hypersetup{bookmarksdepth}% back to tocdepth
      \end{rightcolumn}
    \end{paracol}
  \end{sloppypar}
  \stepcounter{seccoun}
}

% General text
\newcommand{\addtext}[2]{%
  \begin{sloppypar}  % To prevent overfull lines
    \begin{paracol}{2} % specify two columns...
      \begin{leftcolumn*}
        #1
      \end{leftcolumn*}
      \begin{rightcolumn}
        #2
      \end{rightcolumn}
    \end{paracol}
  \end{sloppypar}
}

% Signature section
\newcommand{\addsigsection}[0]{%
  \begin{center}
    \small
    \renewcommand{\arraystretch}{1.2}
    \hspace*{0.75cm}
    \begin{tabular}{|p{0.44\textwidth}|p{0.44\textwidth}|}\hline
      \bfseries\AgreementCustomerName&
      \bfseries\AgreementSupplierName\\

      \hline & \\[0.75cm] &\\\hline

      \TextField[name=SignatoryName,charsize=8pt,value=\AgreementCustomerRepresentative]{\textbf{Name/Name}: }&
      \textbf{Name/Name}: \AgreementSupplierRepresentative
      \\\hline

      \TextField[name=SignatoryTitle,charsize=8pt]{\textbf{Titel/Title}: }&
      \textbf{Titel/Title}: \AgreementSupplierTitle
      \\\hline

      \TextField[name=SignedDate,charsize=8pt]{\textbf{Datum/Date}: }&
      \textbf{Datum/Date}: \AgreementSupplierDate
      \\\hline
    \end{tabular}
  \end{center}
}

% Intro section
\newcommand{\addintro}[8]{%
  #1
  \par\medskip
  {\bfseries\AgreementCustomerName,}

  \par#2

  \par
  \begin{flushright}
  \bfseries\textendash{} ``#3'' \textendash{}
  \end{flushright}

  \par
  \noindent #4
  \medskip\par

  \medskip\par
  {\bfseries \AgreementSupplierName,}

  \par#5

  \begin{flushright}
    \bfseries\textendash{} ``#6'' \textendash{}
  \end{flushright}

  \medskip\par#7

  \medskip\par#8
}

% Clause
\newcommand{\addclause}[5]{%
\refstepcounter{clausecount} % Increase the clausecont counter
  \begin{sloppypar}  % To prevent overfull lines
    \begin{paracol}{2} % specify two columns...
      \begin{leftcolumn*}
        \begin{itemize}
          \item[\bfseries\theclausecount\label{#1}] \textbf{#2} \\ #4
        \end{itemize}
      \end{leftcolumn*}
      \begin{rightcolumn}
        \begin{itemize}
          \item[\bfseries\theclausecount] \textbf{#3} \\ #5
        \end{itemize}
      \end{rightcolumn}
    \end{paracol}
  \end{sloppypar}
}

% --- Adds a subclause ---%
\newcommand{\addsubclause}[5]{%
\refstepcounter{subclausecount} % Increase the subclausecont counter
  \begin{sloppypar}  % To prevent overfull lines
    \begin{paracol}{2} % specify two columns...
      \begin{leftcolumn*}
        \begin{itemize}
          \item[\bfseries\thesubclausecount\label{#1}] \textbf{#2} \\ #4
        \end{itemize}
      \end{leftcolumn*}
      \begin{rightcolumn}
        \begin{itemize}
          \item[\bfseries\thesubclausecount] \textbf{#3} \\ #5
        \end{itemize}
      \end{rightcolumn}
    \end{paracol}
  \end{sloppypar}
}

% --- Adds a subsubclause ---%
\newcommand{\addsubsubclause}[5]{%
\refstepcounter{subsubclausecount} % Increase the subclausecont counter
  \begin{sloppypar}  % To prevent overfull lines
    \begin{paracol}{2} % specify two columns...
      \begin{leftcolumn*}
        \begin{itemize}
          \item[\bfseries\thesubsubclausecount\label{#1}] \textbf{#2} \\ #4
        \end{itemize}
      \end{leftcolumn*}
      \begin{rightcolumn}
        \begin{itemize}
          \item[\bfseries\thesubsubclausecount] \textbf{#3} \\ #5
        \end{itemize}
      \end{rightcolumn}
    \end{paracol}
  \end{sloppypar}
}

% Title
\newcommand{\addtitle}[2]{%
  \begin{sloppypar}  % To prevent overfull lines
    \begin{paracol}{2} % specify two columns...
      \begin{leftcolumn*}
        \begin{center}
          \LARGE\bfseries#1
        \end{center}
      \end{leftcolumn*}
      \begin{rightcolumn}
        \begin{center}
          \LARGE\bfseries#2
        \end{center}
      \end{rightcolumn}
    \end{paracol}
  \end{sloppypar}
  \medskip
}

% NOTE: all the sections inserted through the \addsection command will appear
% in the TOC's
\newcommand{\insertTOCs}{%
  \setlength{\cftbeforesecskip}{-2pt} % Space between lines
  \renewcommand{\cftsecaftersnum}{.}
  \renewcommand{\cftsecleader}{\cftdotfill{\cftdotsep}}

  \bigskip
  \addtext{%
    \centerline{\large\textbf{Inhaltsverzeichnis}}
  }{%
    \centerline{\large\textbf{Table of Contents}}
  }

  \begin{minipage}[t]{0.47\textwidth}
    \fontsize{8}{12}
    \tableof{d}
  \end{minipage}%
  \hspace*{0.03\textwidth}%
  \begin{minipage}[t]{0.48\textwidth}
    \fontsize{8}{12}
    \tableof{e}
  \end{minipage}%

  \medskip

  {%
  \footnotesize
  \hspace*{0.01\textwidth}%
  \begin{minipage}{0.47\textwidth}
    \centerline{\large\textbf{Anh√§nge}}
    \medskip
    \textbf{Annex 1} \enskip Individualvereinbarungsmuster
  \end{minipage}%
  \hspace*{0.03\textwidth}%
  \begin{minipage}{0.47\textwidth}
    \centerline{\large\textbf{Annexes}}
    \medskip
    \textbf{Annex 1} \enskip Individual Agreement Template
  \end{minipage}
  }

  \toftagstart{b}
  \newpage
}

\ifCustomerIsDomestic\newcommand{\AgreementVenueLeft}{%
  \AgreementVenueCourtLeft
}\else\newcommand{\AgreementVenueLeft}{%
  \AgreementVenueArbitrationLeft
}
\fi

\ifCustomerIsDomestic\newcommand{\AgreementVenueRight}{%
  \AgreementVenueCourtRight
}\else\newcommand{\AgreementVenueRight}{%
  \AgreementVenueArbitrationRight
}
\fi
